apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  labels:
    app: keycloak
spec:
  replicas: {{ .Values.keycloak.replicas }}
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:16.1.0
        ports:
        - containerPort: 8080
        env:
        - name: KEYCLOAK_USER
          value: {{ .Values.keycloak.admin.username | quote }}
        - name: KEYCLOAK_PASSWORD
          value: {{ .Values.keycloak.admin.password | quote }}
        - name: KEYCLOAK_IMPORT
          value: /import/default-realm.json
        - name: DB_VENDOR
          value: {{ .Values.database.vendor}}
        - name: DB_ADDR
          value: {{ .Values.database.host | quote }}
        - name: DB_PORT
          value: {{ .Values.database.port | quote }}
        - name: DB_DATABASE
          value: {{ .Values.database.dbName | quote }}
        - name: DB_USER
          value: {{ .Values.database.admin.username | quote }}
        - name: DB_PASSWORD
          value: {{ .Values.database.admin.password | quote }}
        - name: JGROUPS_DISCOVERY_PROTOCOL
          value: JDBC_PING
        - name: JGROUPS_DISCOVERY_PROPERTIES
          value: "datasource_jndi_name=java:jboss/datasources/KeycloakDS,initialize_sql=\"CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, created TIMESTAMP DEFAULT CURRENT_TIMESTAMP, ping_data BYTEA, constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name))\",remove_all_data_on_view_change=true"
        volumeMounts:
        - name: keycloak-volume
          mountPath: /import
      volumes:
        - name: keycloak-volume
          configMap:
            name: keycloak-realm-configmap